<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 10, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #2193 | 10:21 AM | ğŸŸ£ | Created src/gateway/CLAUDE.md for WebSocket gateway server documentation | ~328 |
</claude-mem-context>

# ç½‘å…³æœåŠ¡å™¨æ¨¡å— (src/gateway/)

[æ ¹ç›®å½•](../../CLAUDE.md) > [src](../CLAUDE.md) > **gateway**

## æ¨¡å—èŒè´£

æä¾› WebSocket ç½‘å…³æœåŠ¡å™¨ï¼Œå®ç°å®¢æˆ·ç«¯è¿æ¥ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ã€AI ä»£ç†é›†æˆå’Œé€šä¿¡æ¸ é“æ¡¥æ¥ã€‚ç½‘å…³æ˜¯ OpenClaw æ¶æ„çš„æ ¸å¿ƒæ¢çº½ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯ï¼ˆWeb UIã€ç§»åŠ¨èŠ‚ç‚¹ã€CLIï¼‰éƒ½é€šè¿‡ç½‘å…³ä¸æœåŠ¡ç«¯é€šä¿¡ã€‚

## ç›®å½•ç»“æ„

```
src/gateway/
â”œâ”€â”€ server/              # æœåŠ¡å™¨å®ç°
â”‚   â”œâ”€â”€ impl.ts          # æœåŠ¡å™¨ä¸»å®ç°
â”‚   â”œâ”€â”€ startup.ts       # å¯åŠ¨æµç¨‹
â”‚   â”œâ”€â”€ ws-runtime.ts    # WebSocket è¿è¡Œæ—¶
â”‚   â”œâ”€â”€ close.ts         # å…³é—­å¤„ç†
â”‚   â”œâ”€â”€ maintenance.ts   # ç»´æŠ¤æ¨¡å¼
â”‚   â””â”€â”€ restart-sentinel.ts  # é‡å¯å“¨å…µ
â”œâ”€â”€ server-methods/      # æœåŠ¡å™¨æ–¹æ³•
â”‚   â”œâ”€â”€ list.ts          # æ–¹æ³•åˆ—è¡¨
â”‚   â”œâ”€â”€ registry.ts      # æ–¹æ³•æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ channels.ts      # æ¸ é“ç›¸å…³æ–¹æ³•
â”‚   â”œâ”€â”€ cron.ts          # å®šæ—¶ä»»åŠ¡æ–¹æ³•
â”‚   â”œâ”€â”€ browser.ts       # æµè§ˆå™¨æ§åˆ¶æ–¹æ³•
â”‚   â”œâ”€â”€ chat.ts          # èŠå¤©ç›¸å…³æ–¹æ³•
â”‚   â”œâ”€â”€ agent-events.ts  # ä»£ç†äº‹ä»¶æ–¹æ³•
â”‚   â”œâ”€â”€ plugins.ts       # æ’ä»¶æ–¹æ³•
â”‚   â”œâ”€â”€ broadcast.ts     # å¹¿æ’­æ–¹æ³•
â”‚   â”œâ”€â”€ node-events.ts   # èŠ‚ç‚¹äº‹ä»¶æ–¹æ³•
â”‚   â”œâ”€â”€ node-subscriptions.ts  # èŠ‚ç‚¹è®¢é˜…
â”‚   â”œâ”€â”€ discovery.ts     # æœåŠ¡å‘ç°
â”‚   â””â”€â”€ reload-handlers.ts  # é‡è½½å¤„ç†å™¨
â”œâ”€â”€ protocol/            # åè®®å®šä¹‰
â”‚   â””â”€â”€ CLAUDE.md        # åè®®æ–‡æ¡£
â”œâ”€â”€ bridge-server.ts     # æ¡¥æ¥æœåŠ¡å™¨
â”œâ”€â”€ client.ts            # å®¢æˆ·ç«¯ç®¡ç†
â”œâ”€â”€ auth.ts              # è®¤è¯å¤„ç†
â”œâ”€â”€ call.ts              # é€šè¯å¤„ç†
â”œâ”€â”€ chat-attachments.ts  # èŠå¤©é™„ä»¶
â”œâ”€â”€ chat-sanitize.ts     # èŠå¤©å†…å®¹æ¸…ç†
â”œâ”€â”€ client.ts            # å®¢æˆ·ç«¯å®ç°
â”œâ”€â”€ config-reload.ts     # é…ç½®é‡è½½
â”œâ”€â”€ hooks.ts             # Hooks å¤„ç†
â”œâ”€â”€ hooks-mapping.ts     # Hooks æ˜ å°„
â”œâ”€â”€ net.ts               # ç½‘ç»œå·¥å…·
â”œâ”€â”€ node-registry.ts     # èŠ‚ç‚¹æ³¨å†Œè¡¨
â”œâ”€â”€ openai-http.ts       # OpenAI HTTP å…¼å®¹
â”œâ”€â”€ openresponses-http.ts  # OpenResponses HTTP
â”œâ”€â”€ origin-check.ts      # æ¥æºæ£€æŸ¥
â”œâ”€â”€ probe.ts             # æ¢é’ˆ
â”œâ”€â”€ server.ts            # æœåŠ¡å™¨å…¥å£
â”œâ”€â”€ session-utils.ts     # ä¼šè¯å·¥å…·
â”œâ”€â”€ sessions-patch.ts    # ä¼šè¯è¡¥ä¸
â”œâ”€â”€ sessions-resolve.ts  # ä¼šè¯è§£æ
â”œâ”€â”€ test-helpers.ts      # æµ‹è¯•åŠ©æ‰‹
â”œâ”€â”€ tools-invoke-http.ts # HTTP å·¥å…·è°ƒç”¨
â””â”€â”€ ws-log.ts            # WebSocket æ—¥å¿—
```

## å…¥å£ä¸å¯åŠ¨

### ä¸»å…¥å£
- **`src/gateway/server.ts`** - æœåŠ¡å™¨ç±»å‹å¯¼å‡º
- **`src/gateway/server/impl.ts`** - æœåŠ¡å™¨ä¸»å®ç°ç±» `GatewayServer`

### å¯åŠ¨æµç¨‹
```typescript
// å…¸å‹å¯åŠ¨æµç¨‹
import { GatewayServer } from "./gateway/server/impl.ts";

const server = new GatewayServer({
  port: 18789,
  verbose: true,
});

await server.start();
```

### é…ç½®é€‰é¡¹
- `port` - ç½‘å…³ç«¯å£ï¼ˆé»˜è®¤ 18789ï¼‰
- `verbose` - è¯¦ç»†æ—¥å¿—æ¨¡å¼
- `maxPayload` - æœ€å¤§è´Ÿè½½é™åˆ¶

## å¯¹å¤–æ¥å£

### GatewayServer æ¥å£
```typescript
interface GatewayServer {
  start(): Promise<void>;
  stop(): Promise<void>;
  broadcast(message: OutboundMessage): void;
  getClientCount(): number;
  getConnectedClients(): Client[];
}
```

### å®¢æˆ·ç«¯æ¥å£
```typescript
interface Client {
  id: string;
  type: ClientType;
  connectionTime: Date;
  lastActivity: Date;
  send(message: OutboundMessage): Promise<void>;
  close(): Promise<void>;
}
```

### æ¶ˆæ¯æ¥å£
```typescript
interface InboundMessage {
  type: string;
  payload: Record<string, unknown>;
  clientId: string;
  timestamp: number;
}

interface OutboundMessage {
  type: string;
  payload: Record<string, unknown>;
  targetId?: string;
}
```

## å­æ¨¡å—è¯¦è§£

### 1. æœåŠ¡å™¨æ ¸å¿ƒ (`server/`)

**èŒè´£**ï¼šWebSocket æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€è¿æ¥å¤„ç†ã€æ¶ˆæ¯è·¯ç”±

**å…³é”®æ–‡ä»¶**ï¼š
- `impl.ts` - `GatewayServer` ä¸»ç±»å®ç°
- `startup.ts` - å¯åŠ¨åºåˆ—å’Œåˆå§‹åŒ–
- `ws-runtime.ts` - WebSocket è¿æ¥è¿è¡Œæ—¶
- `close.ts` - ä¼˜é›…å…³é—­å¤„ç†
- `maintenance.ts` - ç»´æŠ¤æ¨¡å¼åˆ‡æ¢

**æ¥å£**ï¼š
```typescript
class GatewayServer {
  start(): Promise<void>;
  stop(): Promise<void>;
  restart(): Promise<void>;
  enterMaintenanceMode(): void;
  exitMaintenanceMode(): void;
}
```

### 2. æœåŠ¡å™¨æ–¹æ³• (`server-methods/`)

**èŒè´£**ï¼šæ³¨å†Œå’Œåˆ†å‘å„ç§ç½‘å…³æ–¹æ³•è°ƒç”¨

**å…³é”®æ–‡ä»¶**ï¼š
- `registry.ts` - æ–¹æ³•æ³¨å†Œè¡¨
- `channels.ts` - æ¸ é“æ“ä½œï¼ˆå‘é€æ¶ˆæ¯ã€è·å–çŠ¶æ€ï¼‰
- `chat.ts` - èŠå¤©ä¼šè¯ç®¡ç†
- `cron.ts` - å®šæ—¶ä»»åŠ¡è°ƒåº¦
- `browser.ts` - æµè§ˆå™¨æ§åˆ¶
- `broadcast.ts` - æ¶ˆæ¯å¹¿æ’­

**æ¥å£**ï¼š
```typescript
interface ServerMethod {
  name: string;
  handler: (params: unknown) => Promise<unknown>;
  schema?: ZodSchema;
}
```

### 3. åè®®å±‚ (`protocol/`)

**èŒè´£**ï¼šç½‘å…³åè®®ç±»å‹å®šä¹‰ã€æ¶ˆæ¯æ ¼å¼è§„èŒƒ

**ç›¸å…³æ–‡æ¡£**ï¼š
- [åè®®æ–‡æ¡£](./protocol/CLAUDE.md)

### 4. è®¤è¯ä¸å®‰å…¨ (`auth.ts`)

**èŒè´£**ï¼šå®¢æˆ·ç«¯è®¤è¯ã€Token éªŒè¯ã€æ¥æºæ£€æŸ¥

**å…³é”®æ–‡ä»¶**ï¼š
- `auth.ts` - è®¤è¯ä¸­é—´ä»¶
- `origin-check.ts` - è·¨åŸŸæ¥æºéªŒè¯

### 5. HTTP å…¼å®¹å±‚

**èŒè´£**ï¼šæä¾› OpenAI å’Œ OpenResponses å…¼å®¹çš„ HTTP API

**å…³é”®æ–‡ä»¶**ï¼š
- `openai-http.ts` - OpenAI Chat Completions å…¼å®¹
- `openresponses-http.ts` - OpenResponses åè®®å…¼å®¹

## å…³é”®ä¾èµ–ä¸é…ç½®

### æ ¸å¿ƒä¾èµ–
```json
{
  "ws": "^8.18.0",
  "zod": "^3.22.0",
  "hono": "^4.11.8"
}
```

### é…ç½®æ–‡ä»¶
```typescript
// src/gateway/server/runtime-config.ts
interface GatewayConfig {
  port: number;
  maxPayload: number;
  pingInterval: number;
  pingTimeout: number;
  verbose: boolean;
}
```

## æµ‹è¯•ä¸è´¨é‡

### æµ‹è¯•æ–‡ä»¶
- `src/gateway/**/*.test.ts` - å•å…ƒæµ‹è¯•
- `src/gateway/**/*.e2e.test.ts` - ç«¯åˆ°ç«¯æµ‹è¯•

### æµ‹è¯•å‘½ä»¤
```bash
pnpm test src/gateway
pnpm test:gateway:e2e
```

## å¸¸è§é—®é¢˜ (FAQ)

### Q: å¦‚ä½•è¿æ¥ç½‘å…³ï¼Ÿ
A: ä½¿ç”¨ WebSocket åè®®è¿æ¥åˆ° `ws://localhost:18789`ï¼Œå‘é€è®¤è¯æ¶ˆæ¯åå³å¯ä½¿ç”¨ã€‚

### Q: ç½‘å…³æ”¯æŒå“ªäº›å®¢æˆ·ç«¯ç±»å‹ï¼Ÿ
A: æ”¯æŒ Web UIã€ç§»åŠ¨èŠ‚ç‚¹ã€CLI å·¥å…·ã€å…¶ä»–ç½‘å…³æ¡¥æ¥ã€‚

### Q: å¦‚ä½•è°ƒè¯•ç½‘å…³æ¶ˆæ¯ï¼Ÿ
A: å¯ç”¨ `verbose` æ¨¡å¼ï¼Œæˆ–æŸ¥çœ‹ `ws-log.ts` ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶ã€‚

## ç›¸å…³æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- `src/gateway/server/impl.ts` - ç½‘å…³æœåŠ¡å™¨ä¸»å®ç°
- `src/gateway/client.ts` - å®¢æˆ·ç«¯è¿æ¥ç®¡ç†
- `src/gateway/server-methods/registry.ts` - æ–¹æ³•æ³¨å†Œè¡¨

### åè®®æ–‡ä»¶
- `src/gateway/protocol/types.ts` - åè®®ç±»å‹å®šä¹‰
- `src/gateway/protocol/messages.ts` - æ¶ˆæ¯æ ¼å¼

### æµ‹è¯•æ–‡ä»¶
- `src/gateway/server.e2e.test.ts` - æœåŠ¡å™¨ E2E æµ‹è¯•
- `src/gateway/**/*.test.ts` - å•å…ƒæµ‹è¯•

## å˜æ›´è®°å½•

### 2026-02-10 - åˆ›å»ºç½‘å…³æ¨¡å—æ–‡æ¡£
- âœ… åˆ›å»º `src/gateway/CLAUDE.md` æ–‡æ¡£
- ğŸ“‹ è®°å½•æœåŠ¡å™¨ç»“æ„å’Œæ–¹æ³•æ³¨å†Œ
- ğŸ”— å»ºç«‹å­æ¨¡å—å¯¼èˆª
