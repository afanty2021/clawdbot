# Pi 嵌入式辅助函数模块 (pi-embedded-helpers/)

> [返回父模块目录](../) > [返回agents模块目录](../) > **pi-embedded-helpers**

## 模块职责

提供 Pi 嵌入式代理运行时的辅助函数，包括错误分类、处理思维签名、图像尺寸验证、工具重复消息处理等实用功能。

## 目录结构

```
pi-embedded-helpers/
└── helpers.ts          # 辅助函数集合
```

## 关键函数

### 错误分类与处理

```typescript
// 错误分类
function classifyFailoverReason(error: Error): FailoverReason;

// 认证错误检测
function isAuthAssistantError(error: AssistantError): boolean;
function isBillingAssistantError(error: AssistantError): boolean;
function isFailoverAssistantError(error: AssistantError): boolean;
function isRateLimitAssistantError(error: AssistantError): boolean;

// 错误消息检测
function isFailoverErrorMessage(message: string): boolean;
function isTimeoutErrorMessage(message: string): boolean;
function isContextOverflowError(error: Error): boolean;
function isCompactionFailureError(error: Error): boolean;

// 格式化错误文本
function formatAssistantErrorText(error: AssistantError): string;
```

### 图像处理验证

```typescript
// 图像尺寸错误处理
function parseImageSizeError(message: string): ImageSizeError | null;
function parseImageDimensionError(message: string): ImageDimensionError | null;

// 图像尺寸限制
const MAX_IMAGE_SIZE: number = 10 * 1024 * 1024; // 10MB
const MAX_IMAGE_DIMENSION: number = 4096;
```

### 消息重复处理

```typescript
// 消息去重
function isMessagingToolDuplicate(
  toolName: string,
  previousTools: ToolCall[]
): boolean;
```

### 文本处理

```typescript
// 清理用户面对文本
function sanitizeUserFacingText(text: string): string;

// 思维签名处理
function stripThoughtSignatures(messages: Message[]): Message[];
```

### 上下文管理

```typescript
// Bootstrap 最大字符数
function resolveBootstrapMaxChars(): number;
```

## 错误分类 (FailoverReason)

```typescript
type FailoverReason =
  | "auth"           // 认证错误
  | "billing"        // 计费/配额错误
  | "rate_limit"     // 速率限制
  | "context_overflow" // 上下文溢出
  | "compaction"      // 压缩失败
  | "timeout"         // 超时
  | "unknown";        // 未知错误
```

## 使用示例

```typescript
import {
  classifyFailoverReason,
  isAuthAssistantError,
  isBillingAssistantError,
  formatAssistantErrorText,
} from './pi-embedded-helpers.js';

try {
  const result = await runPiAgent(prompt);
  return result;
} catch (error) {
  const reason = classifyFailoverReason(error);
  if (isAuthAssistantError(error)) {
    // 处理认证错误
    await handleAuthError(error);
  } else if (isBillingAssistantError(error)) {
    // 处理计费错误
    await handleBillingError(error);
  }
  return formatAssistantErrorText(error);
}
```

## 与其他模块的交互

- **`src/agents/pi-embedded-runner/`**: 嵌入式运行器，使用辅助函数处理错误
- **`src/agents/pi-embedded-subscribe/`**: 订阅处理器，使用消息去重功能
- **`src/agents/model-auth.ts`**: 认证系统，集成错误分类

## 测试

```bash
# 运行辅助函数测试
pnpm test src/agents/pi-embedded-helpers/*.test.ts
```

## 常见问题 (FAQ)

### Q: 如何处理新的错误类型？
A: 在 `helpers.ts` 中添加新的错误分类函数，并在 `classifyFailoverReason` 中注册。

### Q: 图像尺寸限制可以自定义吗？
A: 硬编码在模块中不可配置，如需修改需调整代码。

## 相关文件

- `src/agents/pi-embedded-runner/` - 嵌入式运行器
- `src/agents/pi-embedded-subscribe/` - 订阅处理器
- `src/agents/model-auth.ts` - 认证系统


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 11, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #2587 | 12:07 AM | ✅ | Created comprehensive Chinese documentation for 6 OpenClaw modules | ~576 |
</claude-mem-context>