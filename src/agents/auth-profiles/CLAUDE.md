<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 9, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #1968 | 4:01 PM | ğŸ”µ | Z.AI Authentication Failure Investigation - Root Cause Identified | ~335 |
</claude-mem-context>

# è®¤è¯é…ç½®æ¨¡å— (auth-profiles/)

[æ ¹ç›®å½•](../../CLAUDE.md) > [src](../CLAUDE.md) > **auth-profiles**

## æ¨¡å—èŒè´£

ç®¡ç† OpenClaw çš„è®¤è¯å‡­æ®é…ç½®ï¼Œæ”¯æŒå¤šç§ LLM æä¾›å•†çš„ API å¯†é’¥ã€OAuth ä»¤ç‰Œå’Œè®¿é—®ä»¤ç‰Œç®¡ç†ã€‚

## ç›®å½•ç»“æ„

```
auth-profiles/
â”œâ”€â”€ auth-profiles.ts      # è®¤è¯é…ç½® CRUD æ“ä½œ
â”œâ”€â”€ types.ts              # å‡­è¯ç±»å‹å®šä¹‰
â”œâ”€â”€ oauth.ts              # OAuth 2.0 æµç¨‹å¤„ç†
â”œâ”€â”€ profiles.ts           # è®¤è¯é…ç½®æ–‡ä»¶æ“ä½œ
â”œâ”€â”€ zai.ts                # Z.AI æä¾›å•†ç‰¹å®šå¤„ç†
â””â”€â”€ *.test.ts             # æµ‹è¯•ç”¨ä¾‹
```

## è®¤è¯é…ç½®æ–‡ä»¶ä½ç½®

### ä¼˜å…ˆçº§é¡ºåº

1. **é¡¹ç›®çº§ `auth-profiles.json`**: `${PROJECT_ROOT}/auth-profiles.json`
2. **å…¨å±€é…ç½®**: `~/.openclaw/agents/main/agent/auth-profiles.json`
3. **ç¯å¢ƒå˜é‡**: `*_API_KEY` ç³»åˆ—ç¯å¢ƒå˜é‡ï¼ˆä½œä¸ºåå¤‡ï¼‰

### é…ç½®æ–‡ä»¶ç»“æ„

```json
{
  "version": 1,
  "profiles": {
    "zai:default": {
      "key": "your-api-key-here",
      "refresh_token": null,
      "expires_at": null
    }
  },
  "usage": {
    "zai:default": {
      "last_used": "2026-02-09T00:00:00Z",
      "request_count": 42
    }
  }
}
```

## å‡­è¯ç±»å‹

### API Key å‡­è¯
- **æ ¼å¼**: `{ key: string }`
- **ä½¿ç”¨åœºæ™¯**: å¤§å¤šæ•° LLM æä¾›å•†ï¼ˆOpenAIã€Anthropicã€Z.AI ç­‰ï¼‰
- **åˆ·æ–°æœºåˆ¶**: æ— è‡ªåŠ¨åˆ·æ–°ï¼Œéœ€æ‰‹åŠ¨æ›´æ–°

### OAuth ä»¤ç‰Œ
- **æ ¼å¼**: `{ key: string, refresh_token: string, expires_at: number }`
- **ä½¿ç”¨åœºæ™¯**: éœ€è¦ OAuth 2.0 æµç¨‹çš„æä¾›å•†
- **åˆ·æ–°æœºåˆ¶**: è‡ªåŠ¨åˆ·æ–°è¿‡æœŸä»¤ç‰Œ

### è®¿é—®ä»¤ç‰Œ
- **æ ¼å¼**: `{ key: string, ... }`
- **ä½¿ç”¨åœºæ™¯**: è‡ªå®šä¹‰è®¤è¯æ–¹æ¡ˆ

## å…³é”®æ–‡ä»¶

### auth-profiles.ts
- `upsertAuthProfile()` - åˆ›å»ºæˆ–æ›´æ–°è®¤è¯é…ç½®
- `listProfilesForProvider()` - åˆ—å‡ºæŒ‡å®šæä¾›å•†çš„æ‰€æœ‰é…ç½®
- `markAuthProfileGood()` - æ ‡è®°é…ç½®ä¸ºæœ‰æ•ˆ
- `clearProviderProfiles()` - æ¸…é™¤æŒ‡å®šæä¾›å•†çš„æ‰€æœ‰é…ç½®

### types.ts
- `AuthProfileStore` - ä¸»é…ç½®å­˜å‚¨ç±»å‹
- `AuthCredentialType` - å‡­è¯ç±»å‹ï¼ˆapi_keyã€oauthã€access_tokenï¼‰
- `AuthProvider` - æä¾›å•†ç±»å‹

### oauth.ts
- `getOAuthUrl()` - ç”Ÿæˆ OAuth æˆæƒ URL
- `exchangeCodeForToken()` - äº¤æ¢æˆæƒç ä¸ºä»¤ç‰Œ
- `refreshAccessToken()` - åˆ·æ–°è®¿é—®ä»¤ç‰Œ

### zai.ts
- `resolveZaiAuth()` - è§£æ Z.AI è®¤è¯
- `normalizeZaiAlias()` - æ ‡å‡†åŒ– Z.AI åˆ«å

## æä¾›å•†é…ç½®

### Z.AI (BigModel/æ™ºè°±AI)
- **å‡­è¯ç±»å‹**: API Key
- **é…ç½®é”®**: `zai:default`
- **ç¯å¢ƒå˜é‡**: `ZAI_API_KEY`
- **API ç«¯ç‚¹**: https://open.bigmodel.cn/api/paas/v4

### Anthropic Claude
- **å‡­è¯ç±»å‹**: API Key
- **é…ç½®é”®**: `anthropic:default`
- **ç¯å¢ƒå˜é‡**: `ANTHROPIC_API_KEY`

### OpenAI
- **å‡­è¯ç±»å‹**: API Key
- **é…ç½®é”®**: `openai:default`
- **ç¯å¢ƒå˜é‡**: `OPENAI_API_KEY`

## æµ‹è¯•

### å•å…ƒæµ‹è¯•
```bash
pnpm test src/agents/auth-profiles/*.test.ts
```

### Live æµ‹è¯•ï¼ˆéœ€è¦çœŸå® API å¯†é’¥ï¼‰
```bash
pnpm test:live src/agents/auth-profiles/*.live.test.ts
```

## å¸¸è§é—®é¢˜ (FAQ)

### Q: 401 è®¤è¯é”™è¯¯å¦‚ä½•æ’æŸ¥ï¼Ÿ
A: 1. æ£€æŸ¥ `auth-profiles.json` ä¸­çš„ API å¯†é’¥æ˜¯å¦æ­£ç¡®
   2. ç¡®è®¤å¯†é’¥æœªè¿‡æœŸ
   3. éªŒè¯æä¾›å•†ç«¯ç‚¹é…ç½®
   4. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œä»£ç†è®¾ç½®

### Q: å¦‚ä½•æ·»åŠ æ–°çš„è®¤è¯æä¾›å•†ï¼Ÿ
A: 1. åœ¨ `types.ts` ä¸­æ·»åŠ æ–°çš„æä¾›å•†ç±»å‹
   2. åœ¨ `auth-profiles.ts` ä¸­å®ç°ç›¸åº”çš„è§£æé€»è¾‘
   3. æ·»åŠ å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹

### Q: API å¯†é’¥ä¼šå®šæœŸåˆ·æ–°å—ï¼Ÿ
A: API Key å‡­è¯æ²¡æœ‰è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ã€‚OAuth ä»¤ç‰Œæ”¯æŒè‡ªåŠ¨åˆ·æ–°ã€‚

## ç›¸å…³æ¨¡å—

- **é…ç½®ç³»ç»Ÿ** (`src/config/`) - ä¸»é…ç½®ç®¡ç†
- **æä¾›å•†ä½¿ç”¨** (`src/infra/provider-usage.*.ts`) - API è°ƒç”¨å°è£…
- **æ‰©å±•ç³»ç»Ÿ** (`extensions/`) - æ¸ é“ç‰¹å®šçš„è®¤è¯é…ç½®

## å˜æ›´è®°å½•

### 2026-02-09 - è®¤è¯ç³»ç»Ÿæ–‡æ¡£å®Œå–„
- âœ… åˆ›å»ºæ¨¡å—æ–‡æ¡£
- âœ… è®°å½•å‡­è¯ç±»å‹å’Œé…ç½®ç»“æ„
- âœ… å®Œå–„ 401 é”™è¯¯æ’æŸ¥æŒ‡å—
- ğŸ” è¯Šæ–­ Z.AI æä¾›å•†è®¤è¯é—®é¢˜
