# Pi 扩展模块 (pi-extensions/)

> [返回父模块目录](../) > [返回agents模块目录](../) > **pi-extensions**

## 模块职责

Pi 扩展模块提供嵌入式 Pi Agent 的扩展支持，包括会话压缩保护、上下文裁剪、压缩安全保护运行时等功能，用于优化长对话管理和资源使用。

## 目录结构

```
pi-extensions/
├── pi-extensions.ts                   # 扩展主入口
├── compaction-safeguard.ts           # 压缩安全保护
├── compaction-safeguard.test.ts      # 压缩保护测试
├── compaction-safeguard-runtime.ts    # 压缩保护运行时
├── context-pruning/                  # 上下文裁剪
│   ├── context-pruning.ts
│   ├── context-pruning.test.ts
│   └── context-pruning.types.ts
└── pi-embedded-subscribe/            # 订阅处理器（独立子模块）
```

## 核心类型

### CompactionSafeguardConfig

```typescript
interface CompactionSafeguardConfig {
  maxRetries: number;              // 最大重试次数
  retryDelay: number;             // 重试延迟(ms)
  enableFallback: boolean;        // 启用降级方案
  preserveCriticalContext: boolean; // 保留关键上下文
}
```

### ContextPruningConfig

```typescript
interface ContextPruningConfig {
  maxTokens: number;               // 最大 token 数
  preserveRecent: number;          // 保留最近 N 条消息
  priorityOrder: Priority[];      // 优先级顺序
  minContextLength: number;        // 最小上下文长度
}
```

## 关键文件详解

### compaction-safeguard.ts

**职责**: 防止会话压缩导致的上下文丢失

**主要功能**:
- 检测潜在压缩风险
- 安全压缩策略
- 回退机制
- 恢复逻辑

```typescript
class CompactionSafeguard {
  constructor(config: CompactionSafeguardConfig);

  async beforeCompact(session: Session): Promise<boolean>;
  async afterCompact(session: Session): Promise<void>;
  async recover(session: Session): Promise<boolean>;
}
```

### compaction-safeguard-runtime.ts

**职责**: 压缩保护的运行时支持

**主要功能**:
- 实时监控压缩状态
- 资源使用追踪
- 性能指标收集
- 异常告警

### context-pruning/

**职责**: 智能上下文裁剪

**主要功能**:
- 基于 token 的裁剪
- 重要性评分
- 保留关键信息
- 摘要生成

```typescript
class ContextPruner {
  async prune(
    messages: Message[],
    config: ContextPruningConfig
  ): Promise<Message[]>;

  calculateImportance(message: Message): number;
}
```

### pi-embedded-subscribe/

**职责**: 嵌入式会话订阅和流式处理

**详见**: [pi-embedded-subscribe/CLAUDE.md](./pi-embedded-subscribe/CLAUDE.md)

## 使用示例

### 使用压缩保护

```typescript
import { CompactionSafeguard } from './pi-extensions/compaction-safeguard.js';

const safeguard = new CompactionSafeguard({
  maxRetries: 3,
  retryDelay: 1000,
  enableFallback: true,
  preserveCriticalContext: true,
});

const safe = await safeguard.beforeCompact(session);
if (safe) {
  await compactSession(session);
}
```

### 使用上下文裁剪

```typescript
import { ContextPruner } from './pi-extensions/context-pruning/context-pruning.js';

const pruner = new ContextPruner({
  maxTokens: 100000,
  preserveRecent: 10,
  priorityOrder: ['system', 'user', 'assistant', 'tool'],
  minContextLength: 1000,
});

const prunedMessages = await pruner.prune(messages, config);
```

## 与其他模块的交互

- **`src/agents/pi-embedded-runner/`**: 使用压缩保护优化会话
- **`src/agents/pi-embedded-subscribe/`**: 订阅处理器的扩展支持
- **`src/agents/session/`**: 会话管理集成

## 测试

```bash
# 运行压缩保护测试
pnpm test src/agents/pi-extensions/compaction-safeguard.test.ts

# 运行上下文裁剪测试
pnpm test src/agents/pi-extensions/context-pruning/*.test.ts
```

## 常见问题 (FAQ)

### Q: 压缩保护会影响性能吗？
A: 保护机制本身有轻微开销，但可以防止更严重的上下文丢失问题。

### Q: 如何调整上下文裁剪策略？
A: 通过 `ContextPruningConfig` 配置优先级和保留规则。

### Q: 压缩失败怎么办？
A: 系统会自动降级到保守模式，并记录告警。

## 相关文件

- `src/agents/pi-embedded-runner/` - 嵌入式运行器
- `src/agents/pi-embedded-subscribe/` - 订阅处理器
- `src/agents/session/` - 会话管理


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 11, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #2637 | 12:23 AM | ✅ | Committed comprehensive Chinese documentation for 6 OpenClaw modules to git | ~493 |
</claude-mem-context>