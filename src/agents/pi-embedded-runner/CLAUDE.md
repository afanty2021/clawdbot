# Pi 嵌入式运行器模块 (pi-embedded-runner/)

> [返回父模块目录](../) > [返回agents模块目录](../) > **pi-embedded-runner**

## 模块职责

Pi 嵌入式运行器是 OpenClaw AI 代理的核心引擎，负责管理 Pi Agent 的完整生命周期，包括模型配置、历史管理、会话压缩、工具结果截断、上下文溢出处理等关键功能。

## 目录结构

```
pi-embedded-runner/
├── bootstrap.ts           # Bootstrap 上下文构建
├── compact.ts              # 会话压缩
├── errors.ts              # 错误处理扩展
├── extensions.ts          # 扩展支持
├── extra-params.ts        # 额外参数处理
├── google.ts              # Google 特定处理
├── history.ts             # 历史记录管理
├── images.ts              # 图像处理
├── lanes.ts               # 车道管理
├── messaging-dedupe.ts    # 消息去重
├── model.ts               # 模型解析
├── openai.ts              # OpenAI 兼容处理
├── runs.ts                # 运行状态管理
├── sandbox-info.ts        # 沙箱信息
├── session-manager-cache.ts # 会话管理器缓存
├── system-prompt.ts       # 系统提示
├── thinking.ts            # 思维处理
├── tool-result-truncation.ts # 工具结果截断
├── tool-split.ts          # 工具拆分
├── turns.ts               # 轮次管理
├── types.ts               # 类型定义
└── run/                   # 运行核心逻辑
    ├── attempt.ts         # 运行尝试
    ├── params.ts          # 运行参数
    └── payloads.ts        # 负载构建
```

## 核心类型

### EmbeddedPiAgentMeta

```typescript
interface EmbeddedPiAgentMeta {
  id: string;                    // 代理 ID
  provider: string;              // 提供商
  model: string;                // 模型
  createdAt: number;            // 创建时间
  lastUsedAt: number;           // 最后使用时间
  usage: UsageStats;            // 使用统计
}
```

### EmbeddedPiRunResult

```typescript
interface EmbeddedPiRunResult {
  success: boolean;
  output?: string;
  error?: Error;
  usage?: UsageStats;
  failoverReason?: FailoverReason;
}
```

### RunEmbeddedPiAgentParams

```typescript
interface RunEmbeddedPiAgentParams {
  prompt: string;
  systemPrompt?: string;
  model?: string;
  provider?: string;
  maxTurns?: number;
  timeout?: number;
  tools?: Tool[];
  sandbox?: SandboxConfig;
  onChunk?: (chunk: string) => void;
}
```

## 关键文件详解

### run.ts

**职责**: 嵌入式代理运行核心

**主要功能**:
- 运行嵌入式 Pi Agent
- 处理认证配置
- 管理会话生命周期
- 处理错误和故障转移

**关键函数**:
```typescript
async function runEmbeddedPiAgent(
  params: RunEmbeddedPiAgentParams
): Promise<EmbeddedPiRunResult>;
```

### model.ts

**职责**: 模型解析和配置

**主要功能**:
- 解析模型 ID
- 验证模型可用性
- 配置模型参数
- 模型回退策略

```typescript
function resolveModel(params: ModelParams): ResolvedModel;
function getModelCapabilities(model: string): ModelCapabilities;
```

### history.ts

**职责**: 历史记录管理

**主要功能**:
- 加载会话历史
- 保存历史记录
- 历史裁剪
- 上下文窗口管理

```typescript
interface HistoryManager {
  load(sessionId: string): Promise<Message[]>;
  save(sessionId: string, messages: Message[]): Promise<void>;
  trim(sessionId: string, maxTokens: number): Promise<Message[]>;
}
```

### compact.ts

**职责**: 会话压缩

**主要功能**:
- 压缩过长会话
- 摘要生成
- 保留关键信息
- 防止上下文溢出

```typescript
async function compactSession(
  sessionId: string,
  options?: CompactOptions
): Promise<void>;
```

### tool-result-truncation.ts

**职责**: 工具结果截断

**主要功能**:
- 检测过大工具结果
- 截断过长输出
- 保留工具调用签名
- 最小化信息丢失

```typescript
function truncateOversizedToolResults(
  session: Session,
  maxTokens: number
): TruncationResult;
```

## 使用示例

### 基本运行

```typescript
import { runEmbeddedPiAgent } from './pi-embedded-runner/run.js';

const result = await runEmbeddedPiAgent({
  prompt: 'Hello, help me write a function.',
  model: 'sonnet-4-20250514',
  provider: 'anthropic',
  maxTurns: 10,
  onChunk: (chunk) => process.stdout.write(chunk),
});
```

### 带工具运行

```typescript
import { runEmbeddedPiAgent } from './pi-embedded-runner/run.js';

const result = await runEmbeddedPiAgent({
  prompt: 'Search for information.',
  tools: [readFileTool, bashTool],
  sandbox: {
    enabled: true,
    containerImage: 'python:3.11',
  },
});
```

## 与其他模块的交互

- **`src/agents/pi-embedded-helpers/`**: 错误分类和辅助函数
- **`src/agents/pi-embedded-subscribe/`**: 消息订阅和流式输出
- **`src/agents/model-auth.ts`**: 认证和 API 密钥管理
- **`src/agents/sandbox/`**: 沙箱执行环境
- **`src/agents/system-prompt.ts`**: 系统提示构建

## 测试

```bash
# 运行嵌入式运行器测试
pnpm test src/agents/pi-embedded-runner/*.test.ts

# 运行会话压缩测试
pnpm test src/agents/pi-embedded-runner/run.overflow-compaction.test.ts
```

## 常见问题 (FAQ)

### Q: 如何配置默认模型？
A: 在 `models-config.json` 中配置，或通过环境变量 `OPENCLAW_MODEL` 设置。

### Q: 会话压缩如何工作？
A: 当历史记录超过上下文窗口时，系统会压缩旧消息为摘要，保留最近的关键交互。

### Q: 如何处理认证失败？
A: 运行器自动尝试故障转移，使用 `auth-profiles` 中配置的备选认证配置。

## 相关文件

- `src/agents/pi-embedded-helpers/` - 辅助函数
- `src/agents/pi-embedded-subscribe/` - 订阅处理
- `src/agents/model-auth/` - 认证系统
- `src/agents/sandbox/` - 沙箱隔离


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 11, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #2590 | 12:08 AM | ✅ | Created comprehensive Chinese documentation for 6 OpenClaw modules | ~652 |
| #2587 | 12:07 AM | ✅ | Created comprehensive Chinese documentation for 6 OpenClaw modules | ~576 |
</claude-mem-context>