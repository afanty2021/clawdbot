# Pi 订阅处理器模块 (pi-embedded-subscribe/)

> [返回父模块目录](../) > [返回agents模块目录](../) > **pi-embedded-subscribe**

## 模块职责

Pi 嵌入式订阅处理器负责管理 Pi Agent 的实时订阅和流式输出处理，包括消息块处理、工具结果格式化、思维模式支持、代码块处理、回复标记等功能。

## 目录结构

```
pi-embedded-subscribe/
├── pi-embedded-subscribe.ts           # 主订阅处理器
├── pi-embedded-subscribe.types.ts     # 类型定义
├── pi-embedded-subscribe.tools.ts     # 工具处理
├── pi-embedded-subscribe.raw-stream.ts # 原始流处理
├── pi-embedded-subscribe.reply-tags.test.ts # 回复标记测试
├── handlers/                          # 处理器
│   ├── handlers.ts                   # 主处理器
│   ├── handlers.types.ts             # 处理器类型
│   ├── handlers.lifecycle.ts         # 生命周期处理器
│   ├── handlers.messages.ts          # 消息处理器
│   └── handlers.tools.ts             # 工具处理器
└── tests/                            # 测试文件 (*.test.ts)
```

## 核心类型

### SubscribeEmbeddedPiSessionParams

```typescript
interface SubscribeEmbeddedPiSessionParams {
  sessionId: string;
  prompt: string;
  systemPrompt?: string;
  model?: string;
  provider?: string;
  reasoningMode?: ReasoningMode;
  toolResultFormat?: ToolResultFormat;
  blockReplyBreak?: BlockReplyBreakMode;
  onChunk?: (chunk: string) => void;
  onBlockReply?: (reply: BlockReply) => void;
  onReasoningStream?: (reasoning: string) => void;
  onToolCall?: (toolCall: ToolCall) => void;
  onToolResult?: (result: ToolResult) => void;
  tools?: Tool[];
}
```

### BlockReply

```typescript
interface BlockReply {
  id: string;
  type: BlockReplyType;
  content: string;
  toolCallId?: string;
  timestamp: number;
}
```

### ToolResultFormat

```typescript
type ToolResultFormat = "markdown" | "text" | "json";
```

## 关键文件详解

### pi-embedded-subscribe.ts

**职责**: 主订阅处理器入口

**主要功能**:
- 初始化订阅状态
- 管理流式输出
- 处理块级回复
- 支持思维模式

**关键函数**:
```typescript
function subscribeEmbeddedPiSession(
  params: SubscribeEmbeddedPiSessionParams
): EmbeddedPiSession;
```

### handlers/handlers.ts

**职责**: 消息处理器协调

**主要功能**:
- 协调各子处理器
- 管理处理状态
- 错误处理
- 性能监控

### handlers.messages.ts

**职责**: 消息内容处理

**主要功能**:
- 文本块处理
- 代码块高亮
- Markdown 渲染
- 链接提取

### handlers.tools.ts

**职责**: 工具调用处理

**主要功能**:
- 工具调用拦截
- 工具结果格式化
- 重复工具检测
- 工具元数据收集

### handlers.lifecycle.ts

**职责**: 生命周期管理

**主要功能**:
- 会话开始/结束处理
- 资源清理
- 统计收集
- 错误恢复

## 思维模式支持

```typescript
type ReasoningMode =
  | "off"        // 无思维输出
  | "on"         // 完整思维块
  | "stream";    // 流式思维输出
```

## 回复标记模式

```typescript
type BlockReplyBreakMode =
  | "text_end"   // 文本结束时发送
  | "tool_call"  // 工具调用时发送
  | "none";      // 不自动发送
```

## 使用示例

### 基本订阅

```typescript
import { subscribeEmbeddedPiSession } from './pi-embedded-subscribe.js';

const session = subscribeEmbeddedPiSession({
  sessionId: "session-123",
  prompt: "Write a function.",
  model: "sonnet-4-20250514",
  reasoningMode: "stream",
  onChunk: (chunk) => process.stdout.write(chunk),
  onReasoningStream: (reasoning) => console.log("[Thinking]", reasoning),
  onToolCall: (tool) => console.log("[Tool]", tool.name),
  onToolResult: (result) => console.log("[Result]", result.status),
});
```

### 块级回复处理

```typescript
const session = subscribeEmbeddedPiSession({
  sessionId: "session-456",
  prompt: "Generate code.",
  blockReplyBreak: "tool_call",
  onBlockReply: (reply) => {
    console.log(`[Block ${reply.id}] ${reply.type}: ${reply.content}`);
  },
});
```

## 与其他模块的交互

- **`src/agents/pi-embedded-runner/`**: 使用订阅处理器进行流式输出
- **`src/agents/pi-embedded-helpers/`**: 错误分类和消息去重
- **`src/markdown/`**: Markdown 渲染支持
- **`src/auto-reply/`**: 回复指令处理

## 测试

```bash
# 运行订阅处理器测试
pnpm test src/agents/pi-embedded-subscribe/**/*.test.ts
```

## 常见问题 (FAQ)

### Q: 如何禁用代码块处理？
A: 在初始化时不提供代码块相关回调，或设置 `toolResultFormat` 为 `"text"`。

### Q: 思维模式会影响性能吗？
A: `"stream"` 模式需要实时处理，可能会略微增加延迟，但提供更好的用户体验。

### Q: 如何处理长文本回复？
A: 系统会自动分块处理，块大小由 `maxChunkSize` 参数控制。

## 相关文件

- `src/agents/pi-embedded-runner/` - 嵌入式运行器
- `src/agents/pi-embedded-helpers/` - 辅助函数
- `src/markdown/` - Markdown 处理
- `src/auto-reply/` - 回复指令


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 11, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #2590 | 12:08 AM | ✅ | Created comprehensive Chinese documentation for 6 OpenClaw modules | ~652 |
| #2587 | 12:07 AM | ✅ | Created comprehensive Chinese documentation for 6 OpenClaw modules | ~576 |
</claude-mem-context>