# å®šæ—¶ä»»åŠ¡æ¨¡å— (src/cron/)

[æ ¹ç›®å½•](../../CLAUDE.md) > [src](../CLAUDE.md) > **cron**

## æ¨¡å—èŒè´£

æä¾›å®šæ—¶ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œæ”¯æŒå®šæ—¶è§¦å‘ AI ä»£ç†ä»»åŠ¡ã€æ¶ˆæ¯å‘é€ã€ç³»ç»Ÿç»´æŠ¤ç­‰æ“ä½œã€‚è¯¥æ¨¡å—è´Ÿè´£ä»»åŠ¡çš„è®¡åˆ’ã€è°ƒåº¦ã€æ‰§è¡Œå’ŒçŠ¶æ€è¿½è¸ªã€‚

## ç›®å½•ç»“æ„

```
src/cron/
â”œâ”€â”€ service/             # å®šæ—¶ä»»åŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ service.ts      # æœåŠ¡ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ jobs.ts         # ä»»åŠ¡å®šä¹‰
â”‚   â”œâ”€â”€ store.ts        # ä»»åŠ¡å­˜å‚¨
â”‚   â”œâ”€â”€ delivery.ts      # ä»»åŠ¡æŠ•é€’
â”‚   â”œâ”€â”€ restart-catchup.ts  # é‡å¯æ¢å¤
â”‚   â””â”€â”€ types.ts        # ç±»å‹å®šä¹‰
â”œâ”€â”€ isolated-agent/     # éš”ç¦»ä»£ç†
â”‚   â”œâ”€â”€ isolated-agent.ts  # éš”ç¦»ä»£ç†
â”‚   â”œâ”€â”€ normalize.ts    # å‚æ•°è§„èŒƒåŒ–
â”‚   â””â”€â”€ run-log.ts      # è¿è¡Œæ—¥å¿—
â”œâ”€â”€ schedule.ts         # è°ƒåº¦å™¨
â”œâ”€â”€ normalize.ts        # è§„èŒƒåŒ–å·¥å…·
â”œâ”€â”€ delivery.ts         # æŠ•é€’å¤„ç†
â”œâ”€â”€ parse.ts            # è§£æå·¥å…·
â”œâ”€â”€ payload-migration.ts  # è´Ÿè½½è¿ç§»
â”œâ”€â”€ cron-protocol-conformance.test.ts  # åè®®ä¸€è‡´æ€§
â”œâ”€â”€ run-log.ts          # è¿è¡Œæ—¥å¿—
â”œâ”€â”€ types.ts            # ç±»å‹å®šä¹‰
â””â”€â”€ validate-timestamp.ts  # æ—¶é—´æˆ³éªŒè¯
```

## å…¥å£ä¸å¯åŠ¨

### ä¸»å…¥å£
- **`src/cron/service/service.ts`** - æœåŠ¡å…¥å£
- **`src/cron/schedule.ts`** - è°ƒåº¦å™¨

### å¯åŠ¨æµç¨‹
```typescript
import { CronService } from "./cron/service/service.ts";

const service = new CronService({
  dataDir: "~/.local/share/openclaw/cron",
});

await service.start();
```

## å¯¹å¤–æ¥å£

### CronService æ¥å£
```typescript
interface CronService {
  start(): Promise<void>;
  stop(): Promise<void>;
  schedule(job: CronJob): Promise<string>;
  unschedule(jobId: string): Promise<void>;
  getJobs(): CronJob[];
  getJob(id: string): CronJob | null;
}
```

### CronJob æ¥å£
```typescript
interface CronJob {
  id: string;
  expression: string;      // Cron è¡¨è¾¾å¼
  type: CronJobType;
  payload: unknown;
  enabled: boolean;
  lastRun?: Date;
  nextRun?: Date;
  runCount: number;
  errorCount: number;
  createdAt: Date;
}
```

### CronJobType æšä¸¾
```typescript
enum CronJobType {
  AGENT_RUN = "agent_run",
  MESSAGE_SEND = "message_send",
  SYSTEM_MAINTENANCE = "system_maintenance",
  DATA_BACKUP = "data_backup",
  CUSTOM = "custom",
}
```

## å­æ¨¡å—è¯¦è§£

### 1. ä»»åŠ¡æœåŠ¡ (`service/`)

**èŒè´£**ï¼šå®šæ—¶ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

**å…³é”®æ–‡ä»¶**ï¼š
- `service.ts` - æœåŠ¡ä¸»é€»è¾‘
- `store.ts` - ä»»åŠ¡æŒä¹…åŒ–
- `jobs.ts` - ä»»åŠ¡ç®¡ç†

**åŠŸèƒ½**ï¼š
- ä»»åŠ¡è°ƒåº¦
- ä»»åŠ¡æ‰§è¡Œ
- é”™è¯¯é‡è¯•
- çŠ¶æ€è¿½è¸ª

### 2. éš”ç¦»ä»£ç† (`isolated-agent/`)

**èŒè´£**ï¼šåœ¨éš”ç¦»ç¯å¢ƒä¸­æ‰§è¡Œ AI ä»£ç†ä»»åŠ¡

**å…³é”®æ–‡ä»¶**ï¼š
- `isolated-agent.ts` - ä»£ç†å…¥å£
- `normalize.ts` - å‚æ•°è§„èŒƒåŒ–
- `run-log.ts` - è¿è¡Œæ—¥å¿—

**ç‰¹æ€§**ï¼š
- Docker éš”ç¦»
- èµ„æºé™åˆ¶
- è¶…æ—¶æ§åˆ¶

### 3. ä»»åŠ¡è°ƒåº¦ (`schedule.ts`)

**èŒè´£**ï¼šè§£æ Cron è¡¨è¾¾å¼å¹¶è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´

**Cron è¡¨è¾¾å¼æ ¼å¼**ï¼š
```bash
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0 - 59)
# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0 - 23)
# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¥ (1 - 31)
# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆ (1 - 12)
# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ˜ŸæœŸ (0 - 6)
# â”‚ â”‚ â”‚ â”‚ â”‚
# * * * * *
```

### 4. ä»»åŠ¡æŠ•é€’ (`delivery.ts`)

**èŒè´£**ï¼šå°†ä»»åŠ¡æŠ•é€’ç»™æ‰§è¡Œå™¨

**æŠ•é€’æ¨¡å¼**ï¼š
- `IMMEDIATE` - ç«‹å³æ‰§è¡Œ
- `DEFERRED` - å»¶è¿Ÿæ‰§è¡Œ
- `RETRY` - å¤±è´¥é‡è¯•

## å…³é”®ä¾èµ–ä¸é…ç½®

### é…ç½®æ–‡ä»¶
```typescript
interface CronConfig {
  enabled: boolean;
  dataDir: string;
  maxConcurrentJobs: number;
  defaultTimeout: number;
  retryAttempts: number;
  retryDelay: number;
}
```

### ç¯å¢ƒå˜é‡
```bash
CRON_ENABLED           # æ˜¯å¦å¯ç”¨
CRON_DATA_DIR         # æ•°æ®ç›®å½•
CRON_MAX_JOBS         # æœ€å¤§å¹¶å‘æ•°
CRON_TIMEOUT_MS       # é»˜è®¤è¶…æ—¶
```

## æµ‹è¯•ä¸è´¨é‡

### æµ‹è¯•æ–‡ä»¶
- `src/cron/**/*.test.ts`

### æµ‹è¯•å‘½ä»¤
```bash
pnpm test src/cron
```

## å¸¸è§é—®é¢˜ (FAQ)

### Q: å¦‚ä½•åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Ÿ
A: ä½¿ç”¨ `cron.schedule()` æ–¹æ³•ï¼Œä¼ å…¥ Cron è¡¨è¾¾å¼å’Œä»»åŠ¡é…ç½®ã€‚

### Q: ä»»åŠ¡æ‰§è¡Œå¤±è´¥ä¼šé‡è¯•å—ï¼Ÿ
A: æ ¹æ®é…ç½®çš„é‡è¯•ç­–ç•¥è‡ªåŠ¨é‡è¯•ã€‚

### Q: å¦‚ä½•æŸ¥çœ‹ä»»åŠ¡å†å²ï¼Ÿ
A: ä½¿ç”¨ `run-log.ts` ä¸­çš„æŸ¥è¯¢æ¥å£ã€‚

## ç›¸å…³æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- `src/cron/service/service.ts` - æœåŠ¡å…¥å£
- `src/cron/schedule.ts` - è°ƒåº¦å™¨
- `src/cron/isolated-agent.ts` - éš”ç¦»ä»£ç†

### CLI æ–‡ä»¶
- `src/cli/cron-cli.ts` - Cron CLI

## å˜æ›´è®°å½•

### 2026-02-10 - åˆ›å»ºå®šæ—¶ä»»åŠ¡æ¨¡å—æ–‡æ¡£
- âœ… åˆ›å»º `src/cron/CLAUDE.md` æ–‡æ¡£
- ğŸ“‹ è®°å½•è°ƒåº¦å’ŒæœåŠ¡ç³»ç»Ÿ
- ğŸ”— å»ºç«‹å®šæ—¶ä»»åŠ¡å¯¼èˆª


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 10, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #2212 | 10:30 AM | ğŸŸ£ | Documentation coverage campaign achieved 100% core module coverage | ~546 |
| #2207 | 10:25 AM | ğŸŸ£ | Documentation coverage significantly improved - 10 new CLAUDE.md files created | ~538 |
</claude-mem-context>