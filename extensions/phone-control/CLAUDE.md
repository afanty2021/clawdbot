# Phone Control 扩展

[返回目录](../CLAUDE.md) > **extensions/phone-control**

## 模块职责

高风险手机节点命令的武装/解除武装功能，支持自动过期。

## 功能概述

### 命令组
- **camera**：`camera.snap`、`camera.clip`
- **screen**：`screen.record`
- **writes**：`calendar.add`、`contacts.add`、`reminders.add`
- **all**：所有上述命令

### 武装机制
- **临时允许**：临时将命令从拒绝列表移除或添加到允许列表
- **自动过期**：支持指定过期时间（30s、10m、2h、1d）
- **手动解除**：支持手动解除武装

### 配置持久化
- **状态文件**：`plugins/phone-control/armed.json`
- **版本管理**：支持 V1 和 V2 两种格式
- **自动恢复**：过期或手动解除时恢复原配置

## 对外接口

### 斜杠命令
```bash
/phone                          # 显示帮助和状态
/phone help                     # 显示帮助信息
/phone status                    # 显示武装状态
/phone arm <group> [duration]     # 武装指定组
/phone disarm                    # 解除武装
```

### 组列表
- `camera` - 相机命令
- `screen` - 屏幕录制
- `writes` - 数据写入（日历、联系人、提醒）
- `all` - 所有命令

### 状态文件
```typescript
// V2（当前）
{
  version: 2,
  armedAtMs: number,
  expiresAtMs: number | null,
  group: "camera" | "screen" | "writes" | "all",
  armedCommands: string[],
  addedToAllow: string[],
  removedFromDeny: string[],
}

// V1（已废弃）
{
  version: 1,
  armedAtMs: number,
  expiresAtMs: number | null,
  removedFromDeny: string[],
}
```

## 关键依赖

### OpenClaw Plugin SDK
- `openclaw/plugin-sdk` - 插件开发工具包

### 守护进程服务
```typescript
{
  id: "phone-control-expiry",
  start: async (ctx) => {
    // 每 15 秒检查一次过期
    setInterval(() => tick(), 15_000);
  },
  stop: async () => {
    // 停止计时器
  },
}
```

## 使用说明

### 武装命令
```bash
# 武装相机 10 分钟
/phone arm camera 10m

# 武装屏幕录制 2 小时
/phone arm screen 2h

# 武装所有命令 30 秒
/phone arm all 30s

# 永久武装（手动解除）
/phone arm writes
```

### 解除武装
```bash
/phone disarm
```

### 查看状态
```bash
/phone status
```

### 持续时间格式
- `30s` - 30 秒
- `10m` - 10 分钟（默认）
- `2h` - 2 小时
- `1d` - 1 天

## 工作原理

### 配置修改
武装时修改 Gateway 配置：
1. **允许列表**：将命令添加到 `gateway.nodes.allowCommands`
2. **拒绝列表**：从 `gateway.nodes.denyCommands` 移除命令

### 解除恢复
解除武装时恢复原配置：
1. **恢复 V1**：将 `removedFromDeny` 添加回拒绝列表
2. **恢复 V2**：
   - 从允许列表移除 `addedToAllow`
   - 将 `removedFromDeny` 添加回拒绝列表

### 自动过期
守护进程每 15 秒检查一次：
1. 读取状态文件
2. 检查 `expiresAtMs`
3. 如果过期，自动解除武装

## 注意事项

1. **权限提示**：iOS 仍会在首次使用时请求权限（相机、照片、联系人等）
2. **Gateway 限制**：只控制 Gateway 允许在手机节点上调用的命令
3. **状态持久化**：武装状态持久化到磁盘，重启后仍有效
4. **过期强制**：过期时间是硬限制，过期后必须重新武装

## 相关文件

### 核心文件
- `index.ts` - 插件入口和命令实现
- `openclaw.plugin.json` - 插件清单

### 状态文件
- `~/.config/openclaw/plugins/phone-control/armed.json`

## 变更记录

### 2026-02-13 - 初始创建
- ✅ 创建 Phone Control 扩展文档
- 📋 记录武装/解除武装机制
- 🔗 建立与移动节点的关联


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>